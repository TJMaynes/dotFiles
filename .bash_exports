#!/bin/bash

[[ -f "$HOME/.bash_secrets" ]]; source $HOME/.bash_secrets

############################################
##############   Exports   #################
############################################

export LANG=en_US.UTF-8
export EDITOR=vi
export PATH=/usr/local/bin:$PATH
export WORKSPACE_DIRECTORY=$HOME/workspace
export GIT_USERNAME=tjmaynes

if [ $TERM = 'dumb' ]; then
  export PS1="\n\w\n\u $ "
else
  export TERM="xterm-256color"
  export PS1="\n\u in \w\$(git branch 2> /dev/null | sed -e '/^[^*]/d' -e 's/* \(.*\)/ (\1)/')\n=> \[$(tput sgr0)\]"
fi

## Rust

export PATH="$HOME/.cargo/bin:$PATH"

# Pyenv

export PYTHON_VERSION=3.8.0
export PYTHON_CONFIGURE_OPTS="--enable-shared"
export PYENV_ROOT="$HOME/.pyenv"
export PATH="$PYENV_ROOT/bin:$PATH"
if command -v pyenv 1>/dev/null 2>&1; then
  eval "$(pyenv init -)"
fi

# GPG

export GPG_TTY=$(tty)

############################################
#############    Aliases   #################
############################################

alias psx='ps -x'
alias create-ssh-key='ssh-keygen -t rsa -b 4096 -C'
alias gen-pass='openssl rand -base64 25 | tr -d /'
alias port-usage='sudo lsof -i -P -n | grep LISTEN'

get-ip-address()
{
  if [[ -z "$(command -v hostname)" ]]; then
    echo "Hostname is not installed on machine"
  else
    hostname -I | awk '{print $1}'
  fi
}

start-ssh-agent()
{
  eval $(ssh-agent -s)
  ssh-add ~/.ssh/id_rsa
}

############################################
##########  Docker / Kubernetes   ##########
############################################

alias k='kubectl'
alias kgp='kubectl get pods'
alias kgd='kubectl get deployments'
alias k8s_start_proxy='kubectl proxy'

k8s_set_token()
{
  KUBERNETES_NAMESPACE=$1
  [[ -z $KUBERNETES_NAMESPACE ]]; KUBERNETES_NAMESPACE="kube-system"

  KUBERNETES_CONTEXT=$2
  [[ -z $KUBERNETES_CONTEXT ]]; KUBERNETES_CONTEXT="docker-desktop"

  KUBERNETES_TOKEN=$(kubectl -n $KUBERNETES_NAMESPACE get secrets -o jsonpath='{.items[0].data.token}') 
  kubectl -n $KUBERNETES_NAMESPACE config set-credentials $KUBERNETES_CONTEXT --token="${KUBERNETES_TOKEN}"

  echo "$KUBERNETES_TOKEN"
}

docker-clean-all()
{
  docker stop $(docker container ls -a -q)
  docker system prune -a -f --all
  docker rm $(docker container ls -a -q)
}

docker-stop-and-remove-image()
{
  docker stop "$(docker ps | grep $1 | awk '{print $1}')"
  docker rm   "$(docker ps | grep $1 | awk '{print $1}')"
  docker rmi  "$(docker images | grep $1 | awk '{print $3}')" --force
}

############################################
################   Other   #################
############################################

pclone()
{
  clone tjmaynes/$1
}

clone()
{
  REPOSITORY=$1
  if [[ -z $REPOSITORY ]]; then
    echo "Please provide a repository name!";
  else
    git clone git@github.com:$REPOSITORY $WORKSPACE_DIRECTORY/$REPOSITORY
    cd $WORKSPACE_DIRECTORY/$REPOSITORY
  fi
}

backup-github-repos()
{
  REPOS=$(curl -s "https://api.github.com/users/$GIT_USERNAME/repos" | python -c "import json, sys; obj=json.load(sys.stdin); lst=[str(obj[i]['name']) for i in range(len(obj))]; print ', '.join(str(p) for p in lst)")
  REPOS=($(echo $REPOS | tr "," "\n"))

  (mkdir -p $WORKSPACE_DIRECTORY || true) && pushd $WORKSPACE_DIRECTORY
  for repo in "${REPOS[@]}"; do
    echo "Backing up $repo repo to $WORKSPACE_DIRECTORY/$repo"
    git clone https://github.com/$GIT_USERNAME/$repo.git $repo
    tar -czf $repo.tar.gz $repo
    rm -rf $repo
  done
  popd
}
